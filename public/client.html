<!DOCTYPE html>
<html>
<head>
  <title>TiMS Client Interface</title>
  <style>
    #statusBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #333;
      color: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 1000000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      box-sizing: border-box;
    }

    #statusLeft {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #iframeContainer {
      position: fixed;
      top: 36px;
      bottom: 0;
      right: 0;
      left: 0;
      overflow: hidden;
    }

    #displayFrame {
      width: 100%;
      height: 100%;
      border: none;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="statusBar">
    <div id="statusLeft">
      <div><strong>ID:</strong> <span id="clientIdDisplay">-</span></div>
      <div><strong>Name:</strong> <span id="clientNameDisplay">-</span></div>
      <div><strong>Page Title:</strong> <span id="pageTitleDisplay">-</span></div>
    </div>
    <div id="connectionStatus" style="font-weight: bold; color: lightgreen;">Connected</div>
  </div>

  <div id="iframeContainer">
    <iframe id="displayFrame"
        src=""
        frameBorder="0">
    </iframe>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let clientID = '';
    let clientName = '';

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    socket.on('connect', () => {
      clientID = getQueryParam('id') || 'UnknownID';
      clientName = getQueryParam('name') || clientID;

      document.getElementById('clientIdDisplay').textContent = clientID;
      document.getElementById('clientNameDisplay').textContent = clientName;

      socket.emit('register', 'client', clientID, clientName);
      document.getElementById('connectionStatus').textContent = 'Connected';
      document.getElementById('connectionStatus').style.color = 'lightgreen';
    });

    socket.on('disconnect', () => {
      document.getElementById('connectionStatus').textContent = 'Disconnected';
      document.getElementById('connectionStatus').style.color = 'red';
    });

    socket.on('updateURL', (url) => {
      const iframe = document.getElementById('displayFrame');
      iframe.src = url;
    });

    socket.on('clientNameUpdate', (newName) => {
      clientName = newName;
      document.getElementById('clientNameDisplay').textContent = newName;
    });

    // Listen for iframe load to update page title
    const iframe = document.getElementById('displayFrame');
    iframe.addEventListener('load', () => {
      try {
        const title = iframe.contentDocument.title || iframe.contentWindow.document.title;
        document.getElementById('pageTitleDisplay').textContent = title || 'No Title';
      } catch (e) {
        document.getElementById('pageTitleDisplay').textContent = 'Cannot access title';
      }
    });
  </script>
</body>
</html>
